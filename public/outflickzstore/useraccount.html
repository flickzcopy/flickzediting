<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outflickz - User Account</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://i.imgur.com/ioWFyQB.png">
   <style>
/* Modernized Tailwind Configuration */
:focus:not(:focus-visible) {
    outline: none;
}
/* Custom transition for view switching - smoother, but adjusted for the new layout */
.view-transition {
    transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
}

/* --- 1. NEW BODY/CONTAINER STYLING FOR SPLIT SCREEN --- */
body {
    /* Clean black/deep gray background for the full canvas */
    background-color: #1f2937; /* bg-gray-800 */
    /* *** CRITICAL: Allow body to grow past viewport height on mobile for scrolling *** */
    min-height: 100vh; 
    overflow-y: auto; 
}

/* General Form Elements - Ensure 100% width and box-sizing for all screen sizes */
.form-group label {
    display: block; /* Ensures label and input are on separate lines */
    margin-bottom: 5px;
    color: #374151; /* Dark text for light form background */
}

.form-group input, 
.form-group select, 
#login-btn, 
#create-btn, 
#verify-btn {
    width: 100%; /* CRITICAL for mobile responsiveness */
    padding: 12px;
    margin-bottom: 15px;
    box-sizing: border-box; /* Includes padding/border in element's total width */
}

/* General Message Container Styling */
#message-container {
    margin-bottom: 20px;
    padding: 10px;
    text-align: center;
}


/* --- 2. DESKTOP STYLES (min-width: 768px) --- */
@media (min-width: 768px) {
    .app-container {
        /* Set up the 2/3 (form) and 1/3 (branding) split */
        display: grid; /* Ensure the grid is applied */
        grid-template-columns: 2fr 1fr; /* Form is 2/3, Branding is 1/3 */
        max-width: 1100px; /* Wider desktop canvas */
        min-height: 80vh; 
        /* Enforce fixed height for desktop layout, centered */
        height: auto;
        max-height: 95vh;
        margin: 5vh auto; /* Center the whole box vertically and horizontally */
        border-radius: 8px; /* Optional: Rounded corners for the container */
        overflow: hidden; /* Prevent form/sidebar overflow */
    }
    
    .form-section {
        padding: 50px; /* Larger desktop padding */
        max-width: none; /* Let the grid manage the width */
        /* Make sure form section is scrollable if content is too long on desktop */
        overflow-y: auto; 
    }
    
    .branding-sidebar {
        display: flex; /* Show sidebar on desktop */
    }
}

/* Form Section Styling (Right Side on Desktop) */
.form-section {
    background-color: #ffffff; 
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 8px 10px -6px rgba(0, 0, 0, 0.1); 
}

/* Branding Sidebar Styling (Left Side on Desktop) */
.branding-sidebar {
    background: linear-gradient(135deg, #374151 0%, #111827 100%); /* bg-gray-700 to bg-gray-900 */
    padding: 30px; /* Default padding for sidebar content */
}


/* --- 3. MOBILE-SPECIFIC STYLES (max-width: 767px) --- */
@media (max-width: 767px) {
    
    .app-container {
        /* Collapse to single column, take full viewport width */
        display: block; /* Disable grid */
        width: 100%;
        /* *** CRITICAL FIX: Set height to auto and remove min-height to allow scrolling *** */
        min-height: auto; 
        height: auto; 
        margin: 0;
        padding: 0;
        border-radius: 0;
    }

    .form-section {
        /* Adapt form to be full-width, similar to the old .auth-container mobile style */
        width: 100%; /* Changed from 90% to 100% for full screen on mobile body */
        margin: 0 auto; /* Center within the screen */
        padding: 25px 20px; /* Reduced padding for smaller screens */
        box-shadow: none; /* Clean look on mobile */
        /* Added padding-top to give space from the top of the viewport */
        padding-top: 40px; 
        /* CRITICAL: Allow the content to scroll freely within the form section */
        overflow-y: visible;
        min-height: 100vh; /* Set min-height here so the *content* pushes the scroll */
    }
    
    .branding-sidebar {
        /* Hide the sidebar completely on mobile to save space and focus user */
        display: none; 
    }

    #message-container {
        width: 100%;
        font-size: 0.95rem; /* Slightly smaller text */
    }
}
</style>

</head>
<body class="min-h-screen p-0 md:p-8"> 

    <div class="app-container w-full md:h-auto md:grid rounded-xl overflow-hidden">
        
        <div class="branding-sidebar hidden md:flex flex-col items-center justify-center p-8 text-white order-2">
            
            <img 
                src="https://i.imgur.com/1Rxhi9q.jpeg" 
                alt="Outflickz Background" 
                class="w-32 h-32 object-cover mb-6 rounded-full border-4 border-white/30 shadow-2xl"
            >
            <h2 class="text-4xl font-extrabold mb-3 tracking-widest text-white">
                OUTFLICKZ
            </h2>
            <p class="text-white/80 text-center text-lg font-light max-w-xs">
                Your Number One Clothing Brand. Seamless access to exclusive fashion and styling.
            </p>
            <div class="mt-8 space-y-2 text-sm text-white/70">
                <p>âœ¨ Fast. Secure. Modern.</p>
                <p>ðŸ›’ Cart Sync Included.</p>
            </div>
        </div>

        <div class="form-section w-full max-w-full md:max-w-none p-6 sm:p-10 lg:p-14 md:order-1 flex flex-col justify-center">
            
            <div class="flex flex-col items-center mb-10">
                <img 
                    src="https://i.imgur.com/1Rxhi9q.jpeg" 
                    alt="Outflickz Logo" 
                    class="w-12 h-auto mb-2 rounded-full shadow-md md:hidden"
                >
                <h1 class="text-4xl font-black text-gray-900 tracking-tight">
                    <span id="auth-header" class="text-gray-900">Sign In</span>
                </h1>
                <p class="text-gray-500 mt-2 text-md font-medium">
                    Welcome Back to Outflickz
                </p>
            </div>

            <div id="message-area" class="hidden mt-6 w-full max-w-md mx-auto">
        </div>

            <div id="auth-views" class="relative overflow-hidden w-full max-w-md mx-auto">
                
                <div id="login-view" class="view-transition opacity-100">
                    <form id="login-form" onsubmit="handleLogin(event)">
                        <div class="mb-5">
                            <label for="login-email" class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                            <input type="email" id="login-email" name="email" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out placeholder-gray-400 text-gray-800"
                                placeholder="Enter your registered email"
                            >
                        </div>
                        <div class="mb-4">
                            <label for="login-password" class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                            <div class="relative">
                                <input type="password" id="login-password" name="password" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out pr-16 placeholder-gray-400 text-gray-800"
                                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                >
                                <button type="button" onclick="togglePasswordVisibility('login-password')" 
                                    class="absolute inset-y-0 right-0 px-3 py-1 my-1 mr-1 text-xs font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    id="toggle-login-password"
                                    aria-label="Toggle password visibility"
                                >
                                    View
                                </button>
                            </div>
                            <div class="text-right mt-2">
                                <button type="button" onclick="showView('forgot')" class="text-sm font-medium text-blue-600 hover:text-blue-800 focus:outline-none focus:underline">
                                    Forgot Password?
                                </button>
                            </div>
                        </div>
                        
                        <button type="submit" id="login-btn" class="w-full bg-black hover:bg-gray-800 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-gray-700/50 mt-4">
                            Sign In
                        </button>
                    </form>

                    <div class="mt-8 text-center text-sm">
                        <p class="text-gray-600">
                            Don't have an account? 
                            <button onclick="showView('create')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out font-semibold focus:outline-none focus:underline">
                                Create an Account
                            </button>
                        </p>
                    </div>
                </div>

             <div id="create-view" class="view-transition hidden absolute top-0 w-full opacity-0">
    <div class="max-h-[65vh] overflow-y-auto pr-2">
        <form id="create-form" onsubmit="handleCreateAccount(event)">
            
            <div class="mb-4 flex space-x-4">
                <div class="w-1/2">
                    <label for="create-firstName" class="block text-sm font-semibold text-gray-700 mb-2">First Name</label>
                    <input type="text" id="create-firstName" name="firstName" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out placeholder-gray-400 text-gray-800"
                        placeholder="John"
                    >
                </div>
                <div class="w-1/2">
                    <label for="create-lastName" class="block text-sm font-semibold text-gray-700 mb-2">Last Name</label>
                    <input type="text" id="create-lastName" name="lastName" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out placeholder-gray-400 text-gray-800"
                        placeholder="Doe"
                    >
                </div>
            </div>

            <div class="mb-5">
                <label for="create-email" class="block text-sm font-semibold text-gray-700 mb-2">Email Address <span class="text-red-500">*</span></label>
                <input type="email" id="create-email" name="email" required 
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out placeholder-gray-400 text-gray-800"
                    placeholder="your.new@example.com"
                >
            </div>
            
            <div class="mb-4 flex space-x-4">
                <div class="w-1/2">
                    <label for="create-phone" class="block text-sm font-semibold text-gray-700 mb-2">Phone Contact <span class="text-red-500">*</span></label>
                    <input type="tel" id="create-phone" name="phone" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out placeholder-gray-400 text-gray-800"
                        placeholder="+1234567890"
                        inputmode="tel"
                    >
                </div>
                <div class="w-1/2">
                    <label for="create-whatsapp" class="block text-sm font-semibold text-gray-700 mb-2">WhatsApp Contact</label>
                    <input type="tel" id="create-whatsapp" name="whatsapp" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out placeholder-gray-400 text-gray-800"
                        placeholder="Same as phone or different"
                        inputmode="tel"
                    >
                </div>
            </div>

            <div class="mb-5">
                <label class="block text-sm font-bold text-gray-800 mb-3">Contact Address <span class="text-red-500">*</span></label>
                
                <div class="space-y-4">
                    <div>
                        <label for="create-street" class="block text-xs font-semibold text-gray-500 mb-1">Street Address <span class="text-red-500">*</span></label>
                        <input type="text" id="create-street" name="street" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 placeholder-gray-400 text-gray-800"
                            placeholder="123 Main St"
                        >
                    </div>

                    <div class="flex space-x-4">
                        <div class="w-1/2">
                            <label for="create-city" class="block text-xs font-semibold text-gray-500 mb-1">City <span class="text-red-500">*</span></label>
                            <input type="text" id="create-city" name="city" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 placeholder-gray-400 text-gray-800"
                                placeholder="Lagos / Accra / Cape Town"
                            >
                        </div>
                        <div class="w-1/2">
                            <label for="create-zip" class="block text-xs font-semibold text-gray-500 mb-1">ZIP/Postal Code (Optional)</label>
                            <input type="text" id="create-zip" name="zip" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 placeholder-gray-400 text-gray-800"
                                placeholder="100001 (Optional)"
                            >
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <div class="w-1/2">
                            <label for="create-country" class="block text-xs font-semibold text-gray-500 mb-1">Country <span class="text-red-500">*</span></label>
                            <select id="create-country" name="country" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 text-gray-800"
                            >
                                <option value="" disabled selected>Select Country</option>
                                <option value="Nigeria">Nigeria</option>
                                <option value="Ghana">Ghana</option>
                                <option value="South Africa">South Africa</option>
                                <option value="Kenya">Kenya</option>
                            </select>
                        </div>
                        <div class="w-1/2">
                            <label for="create-state" class="block text-xs font-semibold text-gray-500 mb-1">State/Province <span class="text-red-500">*</span></label>
                            <select id="create-state" name="state" required disabled
                                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 text-gray-800 bg-gray-50 disabled:bg-gray-100 disabled:text-gray-400"
                            >
                                <option value="" disabled selected>Select State</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <label for="create-password" class="block text-sm font-semibold text-gray-700 mb-2">Password <span class="text-red-500">*</span></label>
                <div class="relative">
                    <input type="password" id="create-password" name="password" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out pr-16 placeholder-gray-400 text-gray-800"
                        placeholder="Min 8 characters"
                    >
                    <button type="button" onclick="togglePasswordVisibility('create-password')" 
                        class="absolute inset-y-0 right-0 px-3 py-1 my-1 mr-1 text-xs font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500"
                        id="toggle-create-password"
                        aria-label="Toggle password visibility"
                    >
                        View
                    </button>
                </div>
            </div>
            <div class="mb-6">
                <label for="confirm-password" class="block text-sm font-semibold text-gray-700 mb-2">Confirm Password <span class="text-red-500">*</span></label>
                <div class="relative">
                    <input type="password" id="confirm-password" name="confirmPassword" required 
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out pr-16 placeholder-gray-400 text-gray-800"
                        placeholder="Re-enter password"
                    >
                    <button type="button" onclick="togglePasswordVisibility('confirm-password')" 
                        class="absolute inset-y-0 right-0 px-3 py-1 my-1 mr-1 text-xs font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500"
                        id="toggle-confirm-password"
                        aria-label="Toggle password visibility"
                    >
                        View
                    </button>
                </div>
            </div>
            
            <button type="submit" id="create-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-blue-500/50">
                Create Account
            </button>
        </form>
    </div>

    <div class="mt-8 text-center text-sm">
        <p class="text-gray-600">
            Already have an account? 
            <button onclick="showView('login')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out font-semibold focus:outline-none focus:underline">
                Back to Sign In
            </button>
        </p>
    </div>
</div>

            <div id="verify-view" class="view-transition hidden absolute top-0 w-full opacity-0">
                <form id="verify-form" onsubmit="handleVerification(event)">
                    <p class="text-center text-gray-700 mb-6">
                        A 6-digit verification code has been sent to <br>
                        <strong id="verify-email-display" class="text-gray-900">user@example.com</strong>.
                    </p>
                    <div class="mb-6">
                        <label for="verify-code" class="block text-sm font-semibold text-gray-700 mb-2">Verification Code</label>
                        <input type="text" id="verify-code" name="code" required maxlength="6" inputmode="numeric" pattern="[0-9]{6}"
                            class="w-full px-4 py-3 text-center text-2xl font-bold tracking-widest border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-green-600 focus:border-green-600 transition duration-150 ease-in-out placeholder-gray-400 text-gray-800"
                            placeholder="______"
                        >
                    </div>
                    <button type="submit" id="verify-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-green-500/50">
                        Verify Account
                    </button>
                </form>
                
                <div class="mt-6 text-center text-sm space-y-3">
                    <button type="button" id="resend-btn" onclick="handleResendCode()" class="text-blue-600 hover:text-blue-800 disabled:text-gray-500 disabled:cursor-not-allowed font-semibold focus:outline-none focus:underline transition duration-150">
                        Resend Code
                    </button>
                    <p class="text-gray-600">
                        <button onclick="showView('login')" class="text-gray-600 hover:text-gray-800 transition duration-150 ease-in-out font-semibold focus:outline-none focus:underline">
                            Back to Sign In
                        </button>
                    </p>
                </div>
            </div>

            <div id="forgot-view" class="view-transition hidden absolute top-0 w-full opacity-0">
                <form id="forgot-form" onsubmit="handleForgotPassword(event)">
                    <p class="text-center text-gray-700 mb-6">
                        Enter your email address and we'll send you a link to reset your password.
                    </p>
                    <div class="mb-6">
                        <label for="forgot-email" class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                        <input type="email" id="forgot-email" name="email" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-600 focus:border-blue-600 transition duration-150 ease-in-out placeholder-gray-400 text-gray-800"
                            placeholder="Enter your registered email"
                        >
                    </div>
                    
                    <button type="submit" id="forgot-btn" class="w-full bg-black hover:bg-gray-800 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-gray-700/50">
                        Send Reset Link
                    </button>
                </form>

                <div class="mt-8 text-center text-sm">
                    <p class="text-gray-600">
                        <button onclick="showView('login')" class="text-blue-600 hover:text-blue-800 transition duration-150 ease-in-out font-semibold focus:outline-none focus:underline">
                            Back to Sign In
                        </button>
                    </p>
                </div>
            </div>
            
        </div>
    </div>
   
<script>
// *** 1. CONFIGURATION ***
const API_BASE_URL = 'https://outflickzs.netlify.app/api';
const REGISTER_ENDPOINT = `${API_BASE_URL}/users/register`;
const VERIFY_ENDPOINT = `${API_BASE_URL}/users/verify`;
const RESEND_ENDPOINT = `${API_BASE_URL}/users/resend-verification`;
const LOGIN_ENDPOINT = `${API_BASE_URL}/users/login`;
const LOGOUT_ENDPOINT = `${API_BASE_URL}/users/logout`; 
const AUTH_TOKEN_KEY = 'userAccessToken'; 
const LOCAL_CART_KEY = 'outflickzLocalCart';
const CART_STORAGE_KEY = 'outflickzCartItemCount'; 

let globalCartItems = []; 
let pendingVerificationEmail = '';
let views = {};
let headerElement, messageArea, container;

// --- STATE/PROVINCE DATA ---
const stateOptions = {
    'Nigeria': ['Abia', 'Adamawa', 'Akwa Ibom', 'Anambra', 'Bauchi', 'Bayelsa', 'Benue', 'Borno', 'Cross River', 'Delta', 'Ebonyi', 'Edo', 'Ekiti', 'Enugu', 'Gombe', 'Imo', 'Jigawa', 'Kaduna', 'Kano', 'Katsina', 'Kebbi', 'Kogi', 'Kwara', 'Lagos', 'Nasarawa', 'Niger', 'Ogun', 'Ondo', 'Osun', 'Oyo', 'Plateau', 'Rivers', 'Sokoto', 'Taraba', 'Yobe', 'Zamfara', 'FCT Abuja'],
    'Ghana': ['Ahafo', 'Ashanti', 'Bono', 'Bono East', 'Central', 'Eastern', 'Greater Accra', 'North East', 'Northern', 'Oti', 'Savannah', 'Upper East', 'Upper West', 'Volta', 'Western', 'Western North'],
    'South Africa': ['Eastern Cape', 'Free State', 'Gauteng', 'KwaZulu-Natal', 'Limpopo', 'Mpumalanga', 'North West', 'Northern Cape', 'Western Cape'],
    'Kenya': ['Baringo', 'Bomet', 'Bungoma', 'Busia', 'Elgeyo-Marakwet', 'Embu', 'Garissa', 'Homa Bay', 'Isiolo', 'Kajiado', 'Kakamega', 'Kericho', 'Kiambu', 'Kilifi', 'Kirinyaga', 'Kisii', 'Kisumu', 'Kitui', 'Kwale', 'Laikipia', 'Lamu', 'Machakos', 'Makueni', 'Mandera', 'Marsabit', 'Meru', 'Migori', 'Mombasa', 'Muranga', 'Nairobi', 'Nakuru', 'Nandi', 'Narok', 'Nyamira', 'Nyandarua', 'Nyeri', 'Samburu', 'Siaya', 'Taita-Taveta', 'Tana River', 'Tharaka-Nithi', 'Trans-Nzoia', 'Turkana', 'Uasin Gishu', 'Vihiga', 'Wajir', 'West Pokot']
};

/**
 * Helper: Secure fetch wrapper for authenticated requests
 */
async function secureUserFetch(url, options = {}) {
    const token = localStorage.getItem(AUTH_TOKEN_KEY);
    const headers = { 'Content-Type': 'application/json', ...options.headers };
    if (token) headers['Authorization'] = `Bearer ${token}`;

    const mergedOptions = { ...options, headers, credentials: 'include' };
    const response = await fetch(url, mergedOptions);

    if (response.status === 401) {
        console.warn("Session expired or unauthorized.");
        localStorage.removeItem(AUTH_TOKEN_KEY);
    }
    return response;
}

/**
 * Helper: Robust JSON parser to handle Netlify 502/HTML errors
 */
async function parseSafeJSON(response) {
    const contentType = response.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
        return await response.json();
    }
    if (!response.ok) {
        throw new Error(`Server Error (${response.status}): The service is currently unavailable. Please try again.`);
    }
    return {};
}

function populateStates() {
    const countrySelect = document.getElementById('create-country');
    const stateSelect = document.getElementById('create-state');
    const selectedCountry = countrySelect.value;
    stateSelect.innerHTML = '<option value="" disabled selected>Select State</option>';
    stateSelect.disabled = true;

    if (selectedCountry && stateOptions[selectedCountry]) {
        stateOptions[selectedCountry].forEach(state => {
            const option = document.createElement('option');
            option.value = state;
            option.textContent = state;
            stateSelect.appendChild(option);
        });
        stateSelect.disabled = false;
    }
}

function showView(viewName) {
    let currentView = Object.values(views).find(v => v.classList.contains('opacity-100') && !v.classList.contains('hidden'));
    const headers = { 'login': 'Sign In', 'create': 'Create Account', 'verify': 'Verify Account', 'forgot': 'Reset Password' };
    headerElement.textContent = headers[viewName] || 'Authentication';

    messageArea.classList.add('hidden');
    messageArea.innerHTML = '';
    const nextView = views[viewName];

    if (!nextView) return;

    if (currentView && currentView !== nextView) {
        currentView.classList.replace('opacity-100', 'opacity-0');
        container.style.height = `${currentView.offsetHeight}px`;

        setTimeout(() => {
            currentView.classList.add('hidden');
            currentView.classList.remove('absolute');
            nextView.classList.remove('hidden');
            nextView.classList.add('absolute');
            container.style.height = `${nextView.offsetHeight}px`;

            setTimeout(() => {
                nextView.classList.remove('absolute', 'opacity-0');
                nextView.classList.add('opacity-100');
                setTimeout(() => { container.style.height = ''; }, 400);
            }, 50);
        }, 400);
    } else {
        nextView.classList.remove('hidden', 'opacity-0');
        nextView.classList.add('opacity-100');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    views = {
        'login': document.getElementById('login-view'),
        'create': document.getElementById('create-view'),
        'verify': document.getElementById('verify-view'),
        'forgot': document.getElementById('forgot-view'),
    };
    headerElement = document.getElementById('auth-header');
    messageArea = document.getElementById('message-area');
    container = document.getElementById('auth-views');

    if (!headerElement || !views.login) return;

    document.getElementById('create-country')?.addEventListener('change', populateStates);
    document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
    document.getElementById('verify-form')?.addEventListener('submit', handleVerification);
    document.getElementById('forgot-form')?.addEventListener('submit', handleForgotPassword);
    document.getElementById('create-form')?.addEventListener('submit', handleCreateAccount);
    document.getElementById('login-form')?.addEventListener('submit', handleLogin);
    document.getElementById('resend-btn')?.addEventListener('click', handleResendCode);

    showView('login');
});

function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const button = document.getElementById(`toggle-${fieldId}`);
    field.type = field.type === 'password' ? 'text' : 'password';
    button.textContent = field.type === 'password' ? 'View' : 'Hide';
}

function displayMessage(message, type = 'info') {
    messageArea.className = 'mt-8 p-4 text-sm rounded-xl font-medium border';
    messageArea.innerHTML = message;
    const colors = {
        success: 'bg-green-100 text-green-800 border-green-300',
        error: 'bg-red-100 text-red-800 border-red-300',
        warning: 'bg-yellow-100 text-yellow-800 border-yellow-300',
        info: 'bg-blue-100 text-blue-800 border-blue-300'
    };
    messageArea.classList.add(...colors[type].split(' '));
    messageArea.classList.remove('hidden');
}

function updateCartBadge() {
    const itemCount = localStorage.getItem(CART_STORAGE_KEY) || '0';
    console.log(`Cart count: ${itemCount}`);
}

async function handleLogin(event) {
    event.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const loginBtn = document.getElementById('login-btn');

    let localCartItems = [];
    try {
        const localCartJson = localStorage.getItem(LOCAL_CART_KEY);
        localCartItems = localCartJson ? JSON.parse(localCartJson) : [];
    } catch (e) { localCartItems = []; }

    loginBtn.textContent = 'Signing in...';
    loginBtn.disabled = true;

    try {
        const response = await fetch(LOGIN_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password, localCartItems })
        });

        const data = await parseSafeJSON(response);

        if (response.ok) {
            if (data.accessToken) localStorage.setItem(AUTH_TOKEN_KEY, data.accessToken);
            localStorage.removeItem(LOCAL_CART_KEY);
            
            try { await fetchAndSetPermanentCartState(); } 
            catch (e) { console.error("Cart sync failed"); }

            displayMessage('Signed in successfully! Redirecting...', 'success');
            setTimeout(() => { window.location.href = 'homepage.html'; }, 1000);
        } else if (response.status === 403 && data.needsVerification) {
            pendingVerificationEmail = email;
            document.getElementById('verify-email-display').textContent = email;
            displayMessage(data.message, 'warning');
            setTimeout(() => { showView('verify'); setResendCooldown(60); }, 1000);
        } else {
            displayMessage(data.message || 'Login failed. Check credentials.', 'error');
        }
    } catch (error) {
        displayMessage(error.message, 'error');
    } finally {
        loginBtn.textContent = 'Sign In';
        loginBtn.disabled = false;
    }
}

async function fetchAndSetPermanentCartState() {  
    try {
        const response = await secureUserFetch(`${API_BASE_URL}/user/cart`);
        const data = await parseSafeJSON(response);
        
        globalCartItems = Array.isArray(data.items) ? data.items : [];
        localStorage.setItem(CART_STORAGE_KEY, globalCartItems.length.toString());
        updateCartBadge();
    } catch (error) {
        console.error('Cart fetch error:', error);
    }
}

async function handleCreateAccount(event) {
    event.preventDefault();
    const form = event.target;
    const email = document.getElementById('create-email').value;
    const password = document.getElementById('create-password').value;
    const createBtn = document.getElementById('create-btn');

    if (password !== document.getElementById('confirm-password').value) {
        return displayMessage('Passwords do not match.', 'error');
    }

    createBtn.textContent = 'Creating...';
    createBtn.disabled = true;

    const payload = {
        firstName: form.firstName.value,
        lastName: form.lastName.value,
        email: email,
        password: password,
        phone: document.getElementById('create-phone').value,
        whatsapp: document.getElementById('create-whatsapp').value,
        address: {
            street: document.getElementById('create-street').value,
            city: document.getElementById('create-city').value,
            state: document.getElementById('create-state').value,
            country: document.getElementById('create-country').value,
            zip: document.getElementById('create-zip').value
        }
    };

    try {
        const response = await fetch(REGISTER_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await parseSafeJSON(response);

        if (response.ok || response.status === 202 || data.userId) {
            pendingVerificationEmail = email;
            document.getElementById('verify-email-display').textContent = email;
            displayMessage(data.message || 'Account created. Please verify.', 'success');
            setTimeout(() => { showView('verify'); setResendCooldown(60); }, 2000);
        } else {
            displayMessage(data.message || 'Registration failed.', 'error');
        }
    } catch (error) {
        displayMessage(error.message, 'error');
    } finally {
        createBtn.textContent = 'Create Account';
        createBtn.disabled = false;
    }
}

async function handleVerification(event) {
    event.preventDefault();
    const code = document.getElementById('verify-code').value.trim();
    const verifyBtn = document.getElementById('verify-btn');
    
    if (code.length !== 6) return displayMessage('Enter 6-digit code.', 'error');

    verifyBtn.textContent = 'Verifying...';
    verifyBtn.disabled = true;

    try {
        const response = await fetch(VERIFY_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: pendingVerificationEmail, code })
        });

        const data = await parseSafeJSON(response);

        if (response.ok) {
            if (data.accessToken) localStorage.setItem(AUTH_TOKEN_KEY, data.accessToken);
            displayMessage('Verified! Redirecting...', 'success');
            setTimeout(() => { window.location.href = 'homepage.html'; }, 1500);
        } else {
            displayMessage(data.message || 'Verification failed.', 'error');
            verifyBtn.disabled = false;
            verifyBtn.textContent = 'Verify Account';
        }
    } catch (error) {
        displayMessage(error.message, 'error');
        verifyBtn.disabled = false;
    }
}

function setResendCooldown(seconds) {
    const btn = document.getElementById('resend-btn');
    btn.disabled = true;
    let timer = seconds;
    const interval = setInterval(() => {
        btn.textContent = `Resend Code (${--timer}s)`;
        if (timer <= 0) {
            clearInterval(interval);
            btn.textContent = 'Resend Code';
            btn.disabled = false;
        }
    }, 1000);
}

async function handleResendCode() {
    if (!pendingVerificationEmail) return showView('create');
    setResendCooldown(60);
    try {
        const response = await fetch(RESEND_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: pendingVerificationEmail })
        });
        const data = await parseSafeJSON(response);
        displayMessage(data.message || 'New code sent!', response.ok ? 'success' : 'error');
    } catch (e) { displayMessage(e.message, 'error'); }
}

function handleForgotPassword(event) {
    event.preventDefault();
    displayMessage(`Reset link sent to ${document.getElementById('forgot-email').value}`, 'success');
    setTimeout(() => showView('login'), 3000);
}

async function handleLogout() {
    displayMessage('Signing out...', 'info');
    try {
        await fetch(LOGOUT_ENDPOINT, { method: 'POST', credentials: 'include' });
    } catch (e) { console.warn("Logout request failed"); }
    
    localStorage.removeItem(AUTH_TOKEN_KEY);
    localStorage.removeItem(LOCAL_CART_KEY);
    localStorage.setItem(CART_STORAGE_KEY, '0');
    window.location.href = 'index.html';
}
</script>
</body>
</html>