<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-commerce Admin - Sales Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://i.imgur.com/ioWFyQB.png">
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #05744b; /* emerald-400 */
            border-radius: 4px;
        }
        body {
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem; /* Slightly reduced base font size */
        }
        .text-xl-reduced {
            font-size: 1.5rem; /* Custom size for headings */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex">

    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-emerald-900 text-white transform transition-transform duration-300 z-30 lg:translate-x-0 -translate-x-full shadow-2xl flex flex-col">
        <div class="p-6 flex-shrink-0">
            <img src="https://i.imgur.com/Fz9w1BA.png" alt="E-commerce Logo" class="h-10 w-auto mb-6 rounded-lg shadow-md border border-emerald-700">
            <h1 class="text-xl font-extrabold text-emerald-400 border-t border-emerald-800 pt-4">Commerce Hub</h1>
        </div>
        
        <nav class="space-y-2 px-4 flex-grow overflow-y-auto">
            <button id="btn-dashboard" onclick="window.location.href='./admin-dashboard.html'" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l-7-7-7 7m10 0v10a1 1 0 01-1 1h-3m-3 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-9 0h10"></path></svg>
                Dashboard
            </button>
            
            <button id="btn-saleslog" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out bg-emerald-600 hover:bg-emerald-700 active-link">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                Sales Log
            </button>
            
            <button id="btn-userorders" onclick="window.location.href='./userorders.html'" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                User Orders
            </button>

            <button id="btn-wearscollection" onclick="window.location.href='./wearscollection.html'" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                Wears Collection
            </button>

            <button id="btn-capscollection" onclick="window.location.href='./capscollection.html'" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 13h10M4 19v-6a3 3 0 013-3h10a3 3 0 013 3v6a3 3 0 01-3 3H7a3 3 0 01-3-3z"></path></svg>
                Caps Collection
            </button>
            
            <button id="btn-newarrivals" onclick="window.location.href='./newarrivals.html'" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                New Arrivals
            </button>
            
            <button id="btn-preorders" onclick="window.location.href='./preorders.html'" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                Pre-Order 
            </button>
            
            <button id="btn-membership" onclick="window.location.href='./membership.html'" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3v-5a2 2 0 00-2-2H5a2 2 0 00-2 2v5a3 3 0 003 3z"></path></svg>
                Membership
            </button>
            <button id="btn-settings" onclick="window.location.href='./admin-dashboard.html#settings'" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out hover:bg-emerald-800 text-emerald-200 hover:text-white">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.526.34.813.486 1.066-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Settings
            </button>
        </nav>
        
        <div class="p-4 flex-shrink-0 border-t border-emerald-800">
            <button id="btn-logout" onclick="logoutAdmin()" class="w-full flex items-center p-3 text-base font-medium rounded-lg transition duration-150 ease-in-out bg-red-600 hover:bg-red-700 text-white shadow-lg">
                <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                Log Out
            </button>
        </div>
    </aside>

    <main class="flex-1 lg:ml-64 p-4 transition-all duration-300">
        <button id="sidebar-toggle" class="lg:hidden fixed top-4 left-4 z-40 p-2 bg-emerald-600 text-white rounded-lg shadow-lg hover:bg-emerald-700 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>

        <section id="content-saleslog" class="content-section p-6 pt-16 lg:pt-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Sales Transaction Log üí∞</h2>
            
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">All Sales Records</h3>
                
                <div class="flex flex-wrap gap-4 mb-4 items-center">
                    <input type="text" id="search-sales" placeholder="Search by Order ID or User..." class="p-2 border border-gray-300 rounded-lg text-sm w-full sm:w-64 focus:border-emerald-500 focus:ring-emerald-500">
                    
                    <select id="filter-collection" class="p-2 border border-gray-300 rounded-lg text-sm focus:border-emerald-500 focus:ring-emerald-500">
                        <option value="all">All Collections</option>
                        <option value="WearsCollection">Wears</option>
                        <option value="CapCollection">Caps</option>
                        <option value="NewArrivals">New Arrivals</option>
                        <option value="PreOrderCollection">Pre-Orders</option>
                    </select>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Order ID
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Customer
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Items Count
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Amount (‚Ç¶)
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Date
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status
                                </th>
                            </tr>
                        </thead>
                        <tbody id="sales-table-body" class="bg-white divide-y divide-gray-200">
                            <tr id="loading-row" class="text-center">
                                <td colspan="6" class="p-4 text-gray-500">
                                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-emerald-600 inline-block mr-2"></div>
                                    Loading sales data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

    </main>

   <script>
    // --- JAVASCRIPT LOGIC ---

    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const salesTableBody = document.getElementById('sales-table-body');

    // Global variable to store fetched data
    let ALL_SALES_DATA = [];

    // Helper function to format Naira currency
    function formatNaira(amount) {
        // Assuming totalAmount is in Naira (not Kobo) as per your schema comments.
        // If it's in Kobo, you'd divide by 100 first: amount / 100.
        return new Intl.NumberFormat('en-NG', {
            style: 'currency',
            currency: 'NGN',
            minimumFractionDigits: 0,
            maximumFractionDigits: 2,
        }).format(amount);
    }

    // Helper function to get status badge classes
    function getStatusBadge(status) {
        let colorClasses;
        switch (status.toLowerCase()) {
            case 'delivered':
            case 'confirmed':
                colorClasses = 'bg-green-100 text-green-800';
                break;
            case 'shipped':
            case 'processing':
                colorClasses = 'bg-blue-100 text-blue-800';
                break;
            case 'pending':
                colorClasses = 'bg-yellow-100 text-yellow-800';
                break;
            case 'cancelled':
            case 'refunded':
            case 'verification failed':
            case 'amount mismatch (manual review)':
            case 'inventory failure (manual review)':
                colorClasses = 'bg-red-100 text-red-800';
                break;
            default:
                colorClasses = 'bg-gray-100 text-gray-800';
                break;
        }
        return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colorClasses}">${status}</span>`;
    }

    /**
     * Renders sales data into the table.
     * @param {Array} data - Filtered sales data (Order documents).
     */
    function renderSalesTable(data) {
        salesTableBody.innerHTML = '';
        
        if (data.length === 0) {
            salesTableBody.innerHTML = `
                <tr class="text-center">
                    <td colspan="6" class="p-6 text-gray-500">No sales transactions match your criteria.</td>
                </tr>
            `;
            return;
        }

        data.forEach(order => {
            const dateObj = new Date(order.createdAt); // Use createdAt from the schema's timestamps
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                year: 'numeric', month: 'short', day: 'numeric' 
            });

            // Assuming the backend populates the userId field to get the customer's name/email.
            const customerName = order.userId?.username || order.userId?.email || order.userId || 'N/A';
            const totalAmount = order.totalAmount; // This is the total price in Naira

            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition duration-100';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.orderReference || order._id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${customerName}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${order.items.length} items</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-emerald-600">${formatNaira(totalAmount)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formattedDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    ${getStatusBadge(order.status)}
                </td>
            `;
            salesTableBody.appendChild(row);
        });
    }

    /**
     * Filters the sales data based on search term AND collection (productType).
     */
    function filterSalesData() {
        const searchTerm = document.getElementById('search-sales').value.toLowerCase();
        const collectionFilter = document.getElementById('filter-collection').value;

        const filteredData = ALL_SALES_DATA.filter(order => {
            const customerIdentifier = order.userId?.username || order.userId?.email || order.userId || '';
            
            // 1. Search term filter (Order ID, User ID/Email/Username)
            const matchesSearch = (order.orderReference && order.orderReference.toLowerCase().includes(searchTerm)) || 
                                  (order._id && order._id.toString().toLowerCase().includes(searchTerm)) ||
                                  (customerIdentifier.toLowerCase().includes(searchTerm));
            
            // 2. Collection filter: Check if any item in the order matches the selected productType
            const matchesCollection = collectionFilter === 'all' || 
                                        (order.items && order.items.some(item => 
                                            // ‚≠ê CRITICAL FIX: Use item.productType for filtering ‚≠ê
                                            item.productType && item.productType === collectionFilter
                                        ));

            return matchesSearch && matchesCollection;
        });

        renderSalesTable(filteredData);
    }

    /**
     * Fetches real sales data from the backend API.
     */
    async function fetchSalesData() {
        try {
            // Get token from localStorage (Assuming you store the admin token there)
            const token = localStorage.getItem('adminToken'); 
            if (!token) {
                 // Redirect to login if no token is found
                window.location.href = './admin-login.html'; 
                return;
            }

            // Replace with your actual backend URL/port
            const response = await fetch('/api/admin/orders/all', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                // If token is invalid or request fails, log and show error
                console.error('Failed to fetch sales data:', response.statusText);
                salesTableBody.innerHTML = `
                    <tr class="text-center">
                        <td colspan="6" class="p-6 text-red-500">Error loading sales data. Server responded with status: ${response.status}</td>
                    </tr>
                `;
                return;
            }

            const data = await response.json();
            ALL_SALES_DATA = data; // Store the fetched data globally
            renderSalesTable(ALL_SALES_DATA); // Render initial view

        } catch (error) {
            console.error('Network or parsing error fetching sales data:', error);
            salesTableBody.innerHTML = `
                <tr class="text-center">
                    <td colspan="6" class="p-6 text-red-500">A network error occurred. Please check server connection.</td>
                </tr>
            `;
        }
    }


    /**
     * Handles the admin logout process.
     */
    function logoutAdmin() {
        console.log("Logging out... Clearing admin token.");
        localStorage.removeItem('adminToken');
        window.location.href = './admin-login.html'; 
    }


    // Initialization on load
    document.addEventListener('DOMContentLoaded', () => {
        // Hide sidebar on small screens
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });
        
        // Fetch and load real data
        fetchSalesData();

        // Add event listeners for filtering
        document.getElementById('search-sales').addEventListener('input', filterSalesData);
        document.getElementById('filter-collection').addEventListener('change', filterSalesData);
    });

    </script>
</body>
</html>